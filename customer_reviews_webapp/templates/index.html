{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Creative - Bootstrap 3 Responsive Admin Template">
  <meta name="author" content="GeeksLabs">
  <meta name="keyword" content="Creative, Dashboard, Admin, Template, Theme, Bootstrap, Responsive, Retina, Minimal">
  <link rel="shortcut icon" href="img/favicon.png">

  <title>Action Miner | Home</title>

  <!-- Bootstrap CSS -->
  <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
  <!-- bootstrap theme -->
  <link href="{% static 'css/bootstrap-theme.css' %}" rel="stylesheet">
  <!--external css-->
  <!-- font icon -->
  <link href="{% static 'css/elegant-icons-style.css' %}" rel="stylesheet" />
  <link href="{% static 'css/font-awesome.min.css' %}" rel="stylesheet" />
  <!-- full calendar css-->
  <link href="{% static 'assets/fullcalendar/fullcalendar/bootstrap-fullcalendar.css' %}" rel="stylesheet" />
  <link href="{% static 'assets/fullcalendar/fullcalendar/fullcalendar.css' %}" rel="stylesheet" />
  <!-- easy pie chart-->
  <link href="{% static 'assets/jquery-easy-pie-chart/jquery.easy-pie-chart.css' %}" rel="stylesheet" type="text/css" media="screen" />
  <!-- owl carousel -->
  <link rel="stylesheet" href="{% static 'css/owl.carousel.css' %}" type="text/css">
  <link href="{% static 'css/jquery-jvectormap-1.2.2.css' %}" rel="stylesheet">
  <!-- Custom styles -->
  <link rel="stylesheet" href="{% static 'css/fullcalendar.css' %}">
  <link href="{% static 'css/widgets.css' %}" rel="stylesheet">
  <link href="{% static 'css/style.css' %}" rel="stylesheet">
  <link href="{% static 'css/style-responsive.css' %}" rel="stylesheet" />
  <link href="{% static 'css/xcharts.min.css' %}" rel=" stylesheet">
  <link href="{% static 'css/jquery-ui-1.10.4.min.css' %}" rel="stylesheet">
  <!-- =======================================================
    Theme Name: NiceAdmin
    Theme URL: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/
    Author: BootstrapMade
    Author URL: https://bootstrapmade.com
  ======================================================= -->
</head>

<body>
  <!-- container section start -->
  <section id="container" class="">


    <header class="header dark-bg">

      <a href="/" class="logo">Action <span class="lite">Miner</span></a>
      
      <div class="top-nav notification-row">
          
        
      </div>
    </header>
    
    <section id="main-content">
      <section class="wrapper">
        <div class="row">
          <div class="col-lg-12">
            <h3 class="page-header"><i class="fa fa-laptop"></i> {{ heading }}</h3>
          </div>
        </div>


        <div class="row">
          <div class="col-lg-3 col-md-3 col-sm-12 col-xs-12">
            <form style="margin: 0; padding: 0;" action="/" method="post" class="form-inline" name="sentMessage" id="proceed_form" >{% csrf_token %}
                <label for="url">Enter the exact URL here:</label>
                <input type="text" class="form-control" name="url_text" id="url" placeholder="Eg: https://www.flipkart.com/apple-iphone-x-space-gray-256-gb/product-reviews/itmexrgvf2yxeqjr?pid=MOBEXRGVCYGG2KXA" style="width: 850px" >
                <br><br>
                <button type="submit" class="btn btn-primary btn-large">Show Actionable Content</button>
            </form>
          </div>
        </div>

        {% if results_heading %}
        <h1> {{results_heading}} </h1>
          {% for feature, list in opinion_words %}
          <button onclick="myFunction({{ forloop.counter }})" style="background: none"> <b>Feature Name: </b> {{ feature }} </button>

          <div id="tree_div_{{forloop.counter}}"></div>

          <div class="container" id="hidediv_{{forloop.counter}}" style="display: none;">
            <h2> <b>Opinion words</b> </h2>
            {% for opinion in list.0 %}
            <div class="row">
              <div class="col-lg-10 offset-lg-2">
                  <h3>{{opinion}}</h3>
              </div>
            </div>
            {% endfor %}
            <h2> <b>Filtered Reviews</b> ({{ list.1|length }} out of {{total}})</h2>
            {% for review_id in list.1 %}
              <div class="row">
                <div class="col-lg-10 offset-lg-2">
                    <h3>{{ id_to_title | get_item:review_id }} (polarity: {{ id_to_polarity | get_item:review_id }})</h3>
                    <p>{{ id_to_text | get_item:review_id }}</p>
                </div>
              </div>
            {% endfor %}
          </div>
          {% endfor %}
        {% endif %}
      </section>
    </section>
    <!--main content end-->
  </section>
  <!-- container section start -->

  <!-- javascripts -->
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="{% static 'js/jquery.js' %}"></script>
  <script src="{% static 'js/jquery-ui-1.10.4.min.js' %}"></script>
  <script src="{% static 'js/jquery-1.8.3.min.js' %}"></script>
  <script type="text/javascript" src="{% static 'js/jquery-ui-1.9.2.custom.min.js' %}"></script>
  <!-- bootstrap -->
  <script src="{% static 'js/bootstrap.min.js' %}"></script>
  <!-- nice scroll -->
  <script src="{% static 'js/jquery.scrollTo.min.js' %}"></script>
  <script src="{% static 'js/jquery.nicescroll.js' %}" type="text/javascript"></script>
  <!-- charts scripts -->
  <script src="{% static 'assets/jquery-knob/js/jquery.knob.js' %}"></script>
  <script src="{% static 'js/jquery.sparkline.js' %}" type="text/javascript"></script>
  <script src="{% static 'assets/jquery-easy-pie-chart/jquery.easy-pie-chart.js' %}"></script>
  <script src="{% static 'js/owl.carousel.js' %}"></script>
  <script src="{% static 'assets/fullcalendar/fullcalendar/fullcalendar.js' %}"></script>
  <!--script for this page only-->
  <script src="{% static 'js/jquery.rateit.min.js' %}"></script>
  <!-- custom select -->
  <script src="{% static 'js/jquery.customSelect.min.js' %}"></script>
  <script src="{% static 'assets/chart-master/Chart.js' %}"></script>

  <!--custome script for all page-->
  <script src="{% static 'js/scripts.js' %}"></script>
  <!-- custom script for this page-->
  <script src="{% static 'js/jquery-jvectormap-1.2.2.min.js' %}"></script>
  <script src="{% static 'js/jquery-jvectormap-world-mill-en.js' %}"></script>
  <script src="{% static 'js/jquery.autosize.min.js' %}"></script>
  <script src="{% static 'js/jquery.placeholder.min.js' %}"></script>
  <script src="{% static 'js/jquery.slimscroll.min.js' %}"></script>
  <script type="text/javascript">
    function myFunction(counter) {
      var x = document.getElementById("hidediv_"+(counter));
      console.log("MyFunction");
      if (x.style.display === "none") {
          x.style.display = "block";
          var json_dictionary = {{ json_dic | js }};
          var opinion_words = {{opinion_words | js}};
          var feature = opinion_words[counter][0];
          show_tree(json_dictionary[feature], counter);
      } else {
          x.style.display = "none";
      }
    };
  </script>
  <script type="text/javascript">
    function show_tree(json_var,counter){
      console.log("SHOW TREE");
      var margin = {top: 20, right: 120, bottom: 20, left: 120},
        width = 1080 - margin.right - margin.left,
        height = 1500 - margin.top - margin.bottom;
      var i = 0, duration = 750, leaf_count = 0, root;
      var tree;
      var diagonal;
      var svg;

      d3.json(json_var, function(error, flare) {
        if (error) throw error;
        root = flare;
        calculate_leaf_count(root);
        height = 15 * leaf_count - margin.top - margin.bottom
        tree = d3.layout.tree()
          .size([height, width]);
        diagonal = d3.svg.diagonal()
          .projection(function(d) { return [d.y, d.x]; });

        svg = d3.select("#tree_div_"+counter)
          .append("svg")
          .attr("width", width + margin.right + margin.left)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        root.x0 = height / 2;
        root.y0 = 0;

        function collapse(d) {
          if (d.children) {
            d._children = d.children;
            d._children.forEach(collapse);
            d.children = null;
          }
        }

        root.children.forEach(collapse);
        update(root);
        // var first_level = [];
        // root.children.forEach(function(d){
        //   first_level.push(d);
        // });
        // clicker(root, first_level);
      });

      d3.select(self.frameElement).style("height", "500px");

    };


    function calculate_leaf_count(d){
      if(! d.children ){
        leaf_count++;
        return;
      }
      else{
        d.children.forEach(function(node){
          calculate_leaf_count(node);
        });
      }
    };

    function update(source) {

      // Compute the new tree layout.
      var nodes = tree.nodes(root).reverse(),
          links = tree.links(nodes);

      // Normalize for fixed-depth.
      nodes.forEach(function(d) { d.y = d.depth * 250; });

      // Update the nodes…
      var node = svg.selectAll("g.node")
          .data(nodes, function(d) { return d.id || (d.id = ++i); });

      // Enter any new nodes at the parent's previous position.
      var nodeEnter = node.enter().append("g")
          .attr("class", "node")
          .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
          .on("click", click);

      nodeEnter.append("circle")
          .attr("r", 1e-6)
          .style("fill", function(d) { return d._children ? "darkblue" : "#fff"; });

      nodeEnter.append("text")
          .attr("x", function(d) { return d.children || d._children ? -10 : 10; })
          .attr("dy", ".35em")
          .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
          .text(function(d) { return d.name; })
          .style("fill", function(d) {
              if(d.name.indexOf(",") != -1)
                return "YellowGreen";
          })
          .style("fill-opacity", 1e-6);

      // Transition nodes to their new position.
      var nodeUpdate = node.transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

      nodeUpdate.select("circle")
          .attr("r", 4.5)
          .style("fill", function(d) { return d._children ? "darkblue" : "#fff"; });

      nodeUpdate.select("text")
          .style("fill-opacity", 1);

      // Transition exiting nodes to the parent's new position.
      var nodeExit = node.exit().transition()
          .duration(duration)
          .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
          .remove();

      nodeExit.select("circle")
          .attr("r", 1e-6);

      nodeExit.select("text")
          .style("fill-opacity", 1e-6);

      // Update the links…
      var link = svg.selectAll("path.link")
          .data(links, function(d) { return d.target.id; });

      // Enter any new links at the parent's previous position.
      link.enter().insert("path", "g")
          .attr("class", "link")
          .attr("d", function(d) {
            var o = {x: source.x0, y: source.y0};
            return diagonal({source: o, target: o});
          });

      // Transition links to their new position.
      link.transition()
          .duration(duration)
          .attr("d", diagonal);

      // Transition exiting nodes to the parent's new position.
      link.exit().transition()
          .duration(duration)
          .attr("d", function(d) {
            var o = {x: source.x, y: source.y};
            return diagonal({source: o, target: o});
          })
          .remove();

      // Stash the old positions for transition.
      nodes.forEach(function(d) {
        d.x0 = d.x;
        d.y0 = d.y;
      });
    }

    // Toggle children on click.
    function click(d) {
      if (d.children) {
        d._children = d.children;
        d.children = null;
      } else {
        d.children = d._children;
        d._children = null;
      }
      update(d);
    }

    function click_button(){
        // var new_arr = [];
        // root.children.forEach(function(d){
        //   click(d);
        //   d.children.forEach(function(f){
        //     new_arr += f
        //   });
        // });
        // console.log(new_arr);
        // for(var i =0; i< new_arr.length ; i++){
        //   click(new_arr[i]);
        // }
        $('#play_tree').prop("disabled", true);
        $('#play_tree').css("background-color", "DarkGray")
        var arr = [];
        root.children.forEach(function(d){
          arr.push(d);
        });
        timed_clicker(root, arr);
        console.log("button clicked!");
    }

    function timed_clicker(d, arr){
      if(! d.children ){
        return;
      }
      else{
        d.children.forEach(function(node){
          // if(node.text != arr[arr.length - 1].text){
            setTimeout(function(){
              click(node);  
            }, 1000);
          // }

          setTimeout(function(){
            timed_clicker(node, arr);
          }, 3000);
        });
      }
    }

    function clicker(d, arr){
      if(! d.children ){
        return;
      }
      else{
        d.children.forEach(function(node){
          if(node.text != arr[arr.length - 1].text){
              click(node);
          }
          clicker(node, arr);
        });
      }
    }
  </script>
  

</body>

</html>
